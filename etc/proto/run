#!/bin/bash

tar -C ${GOPATH}/src/github.com/pachyderm/pachyderm -xf /dev/stdin

# Make sure the proto compiler is reasonably up-to-date so that our compiled
# protobufs aren't generated by stale tools
max_age="$(date --date="1 month ago" +%s)"
if [[ "${max_age}" -gt "$(cat /last_run_time)" ]]; then
    PRE="\e[1;31m~\e[0m"
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    echo -e "${PRE} \e[1;31mWARNING:\e[0m pachyderm_proto is out of date" >/dev/stderr
    echo -e "${PRE} please run" >/dev/stderr
    echo -e "${PRE}   make DOCKER_BUILD_FLAGS=--no-cache proto" >/dev/stderr
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    exit 1
fi

cd ${GOPATH}/src/github.com/pachyderm/pachyderm
for i in $(find src -name "*.proto"); do \
    if ! grep -q 'go_package' "${i}"; then
        echo -e "\e[1;31mError:\e[0m missing \"go_package\" declaration in ${i}" >/dev/stderr
    fi
    protoc \
        -I${GOPATH}/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
        -I${GOPATH}/src/github.com/gogo/protobuf \
        -Isrc \
        --gofast_out=plugins=grpc,\
Mgoogle/protobuf/duration.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/empty.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/timestamp.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/wrappers.proto=github.com/gogo/protobuf/types,\
Mgogoproto/gogo.proto=github.com/gogo/protobuf/gogoproto,\
:${GOPATH}/src \
    ${i} >/dev/stderr
done

find src -regex ".*\.go" | xargs tar cf -
